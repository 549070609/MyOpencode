================================================================================
                          OpenCode 项目概览文档
================================================================================

一、项目定位
================================================================================

OpenCode 是一个 AI 驱动的代码开发工具，提供智能编程助手功能。它支持：
  - 终端 TUI 界面
  - Web 浏览器界面
  - 桌面应用 (Tauri)
  - VS Code 扩展

项目采用 TypeScript 开发，使用 Bun 运行时，采用 Monorepo 架构管理多个子包。


二、顶层目录结构
================================================================================

openCode/
├── OpenCode.exe                    # 可执行文件
├── OpenCode Dev_1.1.6_x64-setup.exe # 安装包
│
└── opencode-dev/                   # 主要开发目录
    ├── docs/                       # 文档
    │   ├── 提示词/                 # 各类AI提示词文档
    │   └── 核心系统说明/           # 核心系统文档
    │
    ├── install/                    # 安装相关
    │   ├── config/                 # 配置模板
    │   ├── scripts/                # 安装脚本
    │   └── uninstaller/            # 卸载工具
    │
    ├── oh-my-opencode-dev/         # oh-my-opencode 扩展项目
    │
    ├── opencode-dev/               # 核心项目 (Monorepo)
    │   ├── packages/               # 各子包
    │   ├── infra/                  # 基础设施配置
    │   ├── github/                 # GitHub Actions
    │   ├── nix/                    # Nix 构建配置
    │   └── sdks/                   # 外部SDK (VS Code扩展)
    │
    └── tools/                      # 辅助工具脚本


三、核心项目包结构 (opencode-dev/packages/)
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                              核心功能包                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  packages/opencode/     核心 CLI 工具包 (主入口)                             │
│  ├── src/              源代码目录                                            │
│  ├── bin/              可执行入口                                            │
│  └── test/             测试文件                                              │
│                                                                             │
│  packages/sdk/js/      JavaScript SDK                                       │
│  └── 为 TUI 和其他客户端提供与服务器通信的类型安全 API                        │
│                                                                             │
│  packages/plugin/      插件系统                                              │
│  └── 定义插件接口，支持自定义工具和认证扩展                                    │
│                                                                             │
│  packages/util/        通用工具函数                                          │
│  └── 错误处理、类型定义等共享工具                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户界面包                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  packages/app/          Web 前端应用 (SolidJS)                               │
│  └── 浏览器中运行的完整 OpenCode 界面                                         │
│                                                                             │
│  packages/desktop/      桌面应用 (Tauri + Rust)                              │
│  └── 跨平台桌面客户端，封装 Web 界面                                          │
│                                                                             │
│  packages/ui/           UI 组件库                                            │
│  └── 共享组件、图标、字体等资源                                               │
│                                                                             │
│  packages/console/      控制台管理界面                                        │
│  └── 包含 app (前端)、core (数据库)、function、mail、resource                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              其他支持包                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  packages/docs/         项目文档 (MDX 格式)                                  │
│  packages/web/          官方网站 (Astro 框架)                                │
│  packages/enterprise/   企业版功能                                           │
│  packages/slack/        Slack 集成                                          │
│  packages/function/     Serverless 函数                                     │
│  packages/script/       构建和维护脚本                                        │
│  packages/identity/     品牌资源 (logo 等)                                   │
│  packages/extensions/   编辑器扩展 (Zed)                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


四、核心 CLI 工具架构 (packages/opencode/src/)
================================================================================

源代码目录结构：

src/
├── index.ts              # 主入口，CLI 命令注册
│
├── 【会话与消息】
│   ├── session/          # 会话管理
│   │   ├── index.ts      # 会话 CRUD、消息管理
│   │   ├── message-v2.ts # 消息数据结构
│   │   ├── prompt.ts     # 提示处理
│   │   ├── llm.ts        # LLM 调用
│   │   ├── compaction.ts # 上下文压缩
│   │   ├── summary.ts    # 会话摘要
│   │   ├── todo.ts       # 任务列表
│   │   └── prompt/*.txt  # 各种系统提示词
│   │
│   └── share/            # 会话分享功能
│
├── 【AI 提供商】
│   └── provider/
│       ├── provider.ts   # 多 AI 提供商管理
│       ├── models.ts     # 模型定义
│       ├── auth.ts       # 提供商认证
│       └── transform.ts  # 数据转换
│
├── 【工具系统】
│   └── tool/
│       ├── tool.ts       # 工具基础定义
│       ├── registry.ts   # 工具注册中心
│       ├── bash.ts       # 命令执行
│       ├── read.ts       # 文件读取
│       ├── edit.ts       # 文件编辑
│       ├── write.ts      # 文件写入
│       ├── grep.ts       # 文本搜索
│       ├── glob.ts       # 文件匹配
│       ├── codesearch.ts # 代码语义搜索
│       ├── websearch.ts  # 网页搜索
│       ├── webfetch.ts   # 网页获取
│       ├── task.ts       # 子任务代理
│       ├── todo.ts       # 任务列表工具
│       ├── lsp.ts        # LSP 诊断
│       └── batch.ts      # 批量操作
│
├── 【代理系统】
│   ├── agent/
│   │   ├── agent.ts      # 代理定义与管理
│   │   └── prompt/       # 代理专用提示词
│   │
│   └── acp/              # Agent Client Protocol
│
├── 【协议集成】
│   └── mcp/              # Model Context Protocol
│       ├── index.ts      # MCP 客户端管理
│       ├── auth.ts       # OAuth 认证
│       └── oauth-*.ts    # OAuth 流程处理
│
├── 【服务器】
│   └── server/
│       ├── server.ts     # HTTP API 服务器 (Hono)
│       ├── tui.ts        # TUI 控制路由
│       ├── project.ts    # 项目路由
│       └── mdns.ts       # mDNS 服务发现
│
├── 【命令行界面】
│   └── cli/
│       ├── cmd/          # CLI 命令
│       │   ├── run.ts    # 默认运行命令
│       │   ├── serve.ts  # 服务器模式
│       │   ├── web.ts    # Web 模式
│       │   ├── auth.ts   # 认证命令
│       │   ├── mcp.ts    # MCP 管理
│       │   ├── models.ts # 模型管理
│       │   └── tui/      # 终端界面
│       │       ├── app.tsx       # TUI 主应用
│       │       ├── component/    # 界面组件
│       │       ├── context/      # 状态管理
│       │       ├── routes/       # 路由页面
│       │       └── ui/           # UI 基础组件
│       │
│       ├── ui.ts         # CLI 输出美化
│       └── error.ts      # 错误格式化
│
├── 【配置管理】
│   └── config/
│       ├── config.ts     # 配置加载与合并
│       └── markdown.ts   # Markdown 配置解析
│
├── 【权限系统】
│   └── permission/
│       ├── index.ts      # 权限规则
│       ├── next.ts       # 新版权限系统
│       └── arity.ts      # 权限检查
│
├── 【文件操作】
│   └── file/
│       ├── index.ts      # 文件 CRUD
│       ├── ignore.ts     # .gitignore 处理
│       ├── ripgrep.ts    # ripgrep 搜索
│       └── watcher.ts    # 文件监控
│
├── 【语言服务】
│   └── lsp/
│       ├── client.ts     # LSP 客户端
│       ├── server.ts     # 内置 LSP 服务器配置
│       └── language.ts   # 语言检测
│
├── 【项目管理】
│   └── project/
│       ├── project.ts    # 项目配置
│       ├── instance.ts   # 实例状态管理
│       ├── bootstrap.ts  # 初始化
│       └── vcs.ts        # 版本控制
│
├── 【其他模块】
│   ├── auth/             # 认证存储
│   ├── bus/              # 事件总线
│   ├── storage/          # 数据持久化
│   ├── snapshot/         # 文件快照
│   ├── format/           # 代码格式化
│   ├── skill/            # 技能定义
│   ├── command/          # 命令模板
│   ├── plugin/           # 插件加载
│   ├── pty/              # 伪终端
│   ├── worktree/         # Git worktree
│   │
│   └── util/             # 工具函数
│       ├── log.ts        # 日志系统
│       ├── token.ts      # Token 计算
│       ├── lock.ts       # 锁机制
│       └── ...


五、关键模块功能说明
================================================================================

【1. 会话管理 (Session)】
  - 创建、获取、更新、删除会话
  - 管理会话内的消息（用户消息、AI 响应）
  - 会话分享与取消分享
  - 会话摘要生成
  - 上下文压缩（防止 token 超限）
  - 会话 Fork（从某消息点分叉）
  - 代码变更追踪与回滚

【2. 提供商管理 (Provider)】
  支持的 AI 提供商:
  - Anthropic (Claude)
  - OpenAI (GPT)
  - Google (Gemini, Vertex)
  - Azure OpenAI
  - Amazon Bedrock
  - GitHub Copilot
  - OpenRouter
  - Groq, Cerebras, Mistral 等

  功能：
  - 统一的模型接口
  - 多源认证（环境变量、配置文件、OAuth）
  - 动态模型加载
  - Token 成本计算

【3. 工具系统 (Tool)】
  内置工具:
  - bash: 执行 shell 命令
  - read: 读取文件内容
  - edit: 编辑文件（搜索替换）
  - write: 创建/覆盖文件
  - grep: 文本搜索 (ripgrep)
  - glob: 文件模式匹配
  - codesearch: 语义代码搜索
  - websearch: 网页搜索
  - webfetch: 获取网页内容
  - task: 启动子代理任务
  - todowrite/todoread: 任务列表管理
  - lsp: 语言服务诊断

  扩展机制:
  - 通过配置目录的 tool/*.ts 添加自定义工具
  - 通过插件系统注册工具

【4. 代理系统 (Agent)】
  内置代理:
  - build: 默认构建代理（全功能）
  - plan: 计划模式（只修改计划文件）
  - general: 通用子代理
  - explore: 代码探索代理（只读）
  - compaction: 上下文压缩代理
  - title/summary: 标题/摘要生成

  代理属性:
  - 模式 (primary/subagent)
  - 权限规则
  - 专用提示词
  - 自定义模型

【5. MCP 集成 (Model Context Protocol)】
  - 本地 MCP 服务器（stdio 传输）
  - 远程 MCP 服务器（HTTP/SSE）
  - OAuth 认证流程
  - 动态工具注册
  - 资源和提示模板

【6. HTTP 服务器】
  技术栈: Hono 框架
  功能:
  - RESTful API
  - Server-Sent Events (事件流)
  - WebSocket (PTY 连接)
  - OpenAPI 文档生成
  - CORS 支持
  - mDNS 服务发现

【7. 配置系统】
  配置来源（优先级从低到高）:
  1. 远程 well-known 配置
  2. 全局用户配置 (~/.config/opencode/)
  3. OPENCODE_CONFIG 环境变量指定
  4. 项目本地配置 (opencode.json/jsonc)
  5. OPENCODE_CONFIG_CONTENT 环境变量

  配置内容:
  - 主题、快捷键
  - 默认模型/代理
  - 提供商配置
  - MCP 服务器
  - 权限规则
  - 格式化/LSP 配置

【8. 权限系统】
  权限类型:
  - allow: 允许
  - deny: 拒绝
  - ask: 询问用户

  可控制的操作:
  - 文件读写
  - 命令执行
  - 外部目录访问
  - 网络请求
  - 各种工具调用


六、运行模式
================================================================================

1. 【TUI 模式】(默认)
   命令: opencode
   - 终端内的交互式界面
   - 使用 SolidJS + OpenTUI 构建
   - 支持丰富的快捷键

2. 【服务器模式】
   命令: opencode serve
   - 启动 HTTP API 服务器
   - 供外部客户端连接

3. 【Web 模式】
   命令: opencode web
   - 启动服务器并打开浏览器
   - 使用 Web 界面

4. 【非交互模式】
   命令: opencode -p "提示内容"
   - 单次执行，输出结果后退出
   - 适合脚本集成


七、数据流概览
================================================================================

┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│   用户   │───>│   CLI    │───>│  Server  │───>│   Bus    │
│  输入    │    │   /TUI   │    │  (Hono)  │    │ (事件流) │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
                                      │               │
                                      v               v
                               ┌──────────┐    ┌──────────┐
                               │ Session  │<───│ Provider │
                               │  管理    │    │ (AI SDK) │
                               └──────────┘    └──────────┘
                                      │               │
                                      v               v
                               ┌──────────┐    ┌──────────┐
                               │ Storage  │    │  Tools   │
                               │ (持久化) │    │ (执行)   │
                               └──────────┘    └──────────┘


八、技术栈总结
================================================================================

运行时:      Bun
语言:        TypeScript
UI 框架:     SolidJS (TUI 使用 OpenTUI)
Web 框架:    Hono (服务器)
桌面框架:    Tauri (Rust)
AI SDK:      Vercel AI SDK
构建工具:    Turbo (Monorepo)
包管理:      Bun (Workspace)


================================================================================
                               文档结束
================================================================================

